# BackgroundRemover
Нейросеть для удаления заднего фона с фотографий людей

Основная идея заключается в том, чтобы научить сегментировать фото людей, отделяя объект от фона.
Для этого научим нейросеть возвращать бинарную маску, которую затем будем накладывать на изображение.

Для сегментации изображений хорошо подходят DeepLabV3 и Unet, которые использовались в эксперементах:<br>
DeepLabV3: https://arxiv.org/pdf/1706.05587.pdf<br>
Unet: https://arxiv.org/pdf/1505.04597.pdf

Сеть обучалась на датасете с 5000 изображений, 10% использовались для валидации сети. Каждое из изображений это фотография человека или нескольких людей, размеченая с помощью бинарной маски. Изображения отличаются сложностью фона.

Так же в эксперементах использовался датасет Carvana, который содержит 5000 фотографий машин, в похожих позициях и с одинаковым фоном. Этот датасет на порядок проще относительно сета людей. 10% использовались для валидации сети.<br>

People segmentation: https://drive.google.com/file/d/1X2SzbV8EWOijqbhQVB6o0aDE1nutSmyI/view?usp=sharing<br>
Carvana: https://drive.google.com/file/d/1wr06o0t549jB4dPTPN1hgsgZgfaMCdnb/view?usp=sharing

# Описание архитектуры сетей
  
В эксперементах учавствовало две реализации:<br>

- UNET с 4 слоями последовательной свертки и развертки изображения. Каждый из слоев спуска состоит из двойной конволюции 3x3 и макспуллинга с увеличивающимя числом выходных каналов на каждом из слоев:
  64,128,256,512. После каждой двойнок конволюции запоминаются выходы для последующей конкетенации при подъеме. Выход из последнего слоя спуска попадает в bottleneck где число каналов увеличивается до 1024. Затем проиходит декодировка данных с помощью подъема. Подъем состоит из слоев обратных спуску и число каналов уменьшается в том же порядке 512,256,128,64. В последнем слое сети уменьшаем количество каналов до одного с помощью конволюции 1x1 и возвращаем результат.<br>
  
- DeepLabV3 с ResNet18 из стандартной библиотеки torch.model с предобучеными весами и без последнего полносвязного слоя. Сеть состоит из двух основных частей, которые условно называются энкодер и декодер. Энкодер состоит из урезаной ResNet и ASPP.<br>
  ASPP в свою очередь состоит из 5 параллельных слоев: 3 из них представляют собой конволюцию 3x3 с соответствующими расширениями 6,12,18, одна конволюция 1x1 и image pooling слой. На выходе каждый из слоев выдает 256 канальное изображение, которое затем конкетенируется с другими слоями ASPP. После конкетениррованые выходы из ASPP проспускаются через конволюции для уменьшения количества каналов и полученное изображение увеличивается в 4 раза. <br>
  Параллельно так называемые low level features проходят черз конволюцию для уменльшения числа каналов и конкетенируются с уже увеличенным выходом из ASPP. Все полученные данны х проходят дополнительный слой Squeeze and Excite, который позволяется дополнительно увеличить влияние каналов с большим импактом. <br>
  Далее изображение увеличивалось до исходного размера и подавалось на выход сети после одинарной конволюции с 1 каналом.<br>
	На вход сетям подавалось 3 канальное аугментированное изображение, на выходе получали бинарную маску сегментации картинки.
# Тренировка

Unet<br>
batch = 1<br>
size = 256x256<br>
epoch = 20<br>
learning rate = 1e-4<br>
loss = BSEWithLogitsLoss<br>
optimazer = Adam<br>

DeepLab<br>
batch = 2<br>
size = 512x512<br>
epoch = 5<br>
learning rate = 1e-4<br>
loss = BSEWithLogitsLoss<br>
optimazer = Adam<br>

# Сравнение

Unet показал себя хорошо только на относительно просто сете Carvana. На нем он выдавал около 0,97 на метрике Dice Score  и 0,99 на простом сравнении точно попадания пикселей маски полученной из сети и оригинальной маски. Но на более сложном датасете с людьми точность и Dice Score проседали до 0,7-0,8. Полсе обучения на 20 эпохах с размером батча 1 и размером входной картинки 256x256 Dice Score не превысил 0,86.

DeepLab показала себя гораздо лучше на датасете с людьми, уже на первых трех эпохах она выдавала 0,92 процента простого сравнения и 0,88-0,89 dice score. Работает стабильнее и учится быстрее, требует меньше памяти чем Unet. Изображения на выходе получаются чище, с меньшим количеством дыр.

# Примеры DeepLab

![Image alt](https://github.com/RuslanKozlyak/BackgroundRemover/raw/master/images/DeepLab/before.png)
![Image alt](https://github.com/RuslanKozlyak/BackgroundRemover/raw/master/images/DeepLab/back.png)

![Image alt](https://github.com/RuslanKozlyak/BackgroundRemover/raw/master/images/DeepLab/before1.png)
![Image alt](https://github.com/RuslanKozlyak/BackgroundRemover/raw/master/images/DeepLab/back1.png)


# Примеры Unet

![Image alt](https://github.com/RuslanKozlyak/BackgroundRemover/raw/master/images/Unet/before.png)
![Image alt](https://github.com/RuslanKozlyak/BackgroundRemover/raw/master/images/Unet/back.png)

![Image alt](https://github.com/RuslanKozlyak/BackgroundRemover/raw/master/images/Unet/photo5438328225337031318.jpg)
![Image alt](https://github.com/RuslanKozlyak/BackgroundRemover/raw/master/images/Unet/photo5438328225337031319.jpg)

  
